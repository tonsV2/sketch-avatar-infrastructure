# Sketch Avatar Infrastructure

This project instantiate infrastructure on AWS consisting of an API Gateway serving a simple avatar API from a Lambda function.

The Lambda definition behind the API can be found [here](lambda-api.tf) and configured from [here](vars-lambda_api.tf).

Furthermore, another Lambda function along with an SQS queue will be instantiated. It's defined [here](lambda-worker.tf) and configured from [here](vars-lambda_worker.tf).

# Prerequisites
Before instantiating this infrastructure a few things need to be in place.

A jar file produced from the below repository needs to be produced and uploaded to S3. Please see the readme of that project for details.

https://github.com/tonsV2/sketch-avatar-api

# Deploy
```bash
terraform apply
```

# Test data
Test data can be generated by invoking the below script.
```bash
scripts/create_test_data.sh
```

# API interaction
The following commands are executed using [HTTPie](https://httpie.io/) in a Bash shell.

The API offers no way to upload avatar images to S3. This has to be done manually or by invoking the Worker Lambda.

## List all avatars
```bash
http $(terraform output api_url)
```

## Post new avatar
```bash
echo '{"key": "some/key/avatar.png"}' | http $(terraform output api_url)
```

## Show avatar meta data by id
```bash
http $(terraform output api_url)/1
```

## Retrieve an avatar by id
```bash
http $(terraform output api_url)/1/avatar > avatar.png
```

# Invoke the Worker Lambda
The worker reads S3 keys from an SQS queue and that process can be invoked by running the below script.
```bash
scripts/populate_queue.sh
```
